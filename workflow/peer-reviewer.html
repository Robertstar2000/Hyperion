<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Hypatia - Peer Reviewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .navbar {
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      margin-bottom: 30px;
    }
    .navbar-brand {
      font-weight: bold;
      color: white !important;
      font-size: 24px;
    }
    .nav-link {
      color: rgba(255, 255, 255, 0.8) !important;
      font-size: 16px;
      margin: 0 10px;
    }
    .nav-link:hover {
      color: white !important;
    }
    .workflow-header {
      color: white;
      margin-bottom: 30px;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: none;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      background: linear-gradient(to right, #4776E6, #8E54E9);
      color: white;
      border-bottom: none;
      padding: 15px 20px;
    }
    .card-body {
      padding: 20px;
    }
    .btn-primary {
      background: linear-gradient(to right, #4776E6, #8E54E9);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
    }
    .btn-primary:hover {
      background: linear-gradient(to right, #3a67d4, #7d48d6);
    }
    .progress-container {
      margin-bottom: 30px;
    }
    .progress {
      height: 10px;
      border-radius: 5px;
      background-color: rgba(255, 255, 255, 0.2);
    }
    .progress-bar {
      background: linear-gradient(to right, #FF512F, #F09819);
    }
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .step {
      color: white;
      font-size: 12px;
      text-align: center;
      position: relative;
      width: 10%;
    }
    .step.active {
      font-weight: bold;
      color: #F09819;
    }
    .form-control {
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
    }
    .form-label {
      font-weight: bold;
    }
    .ai-suggestion {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      color: white;
    }
    .ai-suggestion-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .ai-icon {
      width: 30px;
      height: 30px;
      background-color: #F09819;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    .review-comment {
      background-color: #f8f9fa;
      border-left: 4px solid #4776E6;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 0 8px 8px 0;
    }
    .review-comment h6 {
      color: #4776E6;
      margin-bottom: 10px;
    }
    .review-score {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .score-label {
      width: 150px;
      font-weight: bold;
    }
    .score-value {
      width: 50px;
      text-align: center;
      font-weight: bold;
    }
    .score-bar {
      flex-grow: 1;
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin: 0 10px;
      overflow: hidden;
    }
    .score-fill {
      height: 100%;
      background: linear-gradient(to right, #4776E6, #8E54E9);
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">Project Hypatia</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="../dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <span class="nav-link" id="userEmail"></span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logoutBtn">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="workflow-header">
      <h1>Peer Reviewer</h1>
      <p class="lead">Step 9 of 10: Get peer review feedback on your research</p>
    </div>

    <div class="progress-container">
      <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="step-indicator">
        <div class="step">Question</div>
        <div class="step">Research</div>
        <div class="step">Hypothesis</div>
        <div class="step">Methodology</div>
        <div class="step">Data</div>
        <div class="step">Experiment</div>
        <div class="step">Analysis</div>
        <div class="step">Conclusion</div>
        <div class="step active">Review</div>
        <div class="step">Publication</div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Peer Review Feedback</h5>
          </div>
          <div class="card-body">
            <div class="mb-4">
              <h6>Overall Assessment:</h6>
              <div class="review-score">
                <span class="score-label">Scientific Merit:</span>
                <div class="score-bar">
                  <div class="score-fill" id="fillScientificMerit" style="width: 0%"></div>
                </div>
                <span class="score-value" id="scoreScientificMerit">0/10</span>
              </div>
              <div class="review-score">
                <span class="score-label">Methodology:</span>
                <div class="score-bar">
                  <div class="score-fill" id="fillMethodology" style="width: 0%"></div>
                </div>
                <span class="score-value" id="scoreMethodology">0/10</span>
              </div>
              <div class="review-score">
                <span class="score-label">Data Analysis:</span>
                <div class="score-bar">
                  <div class="score-fill" id="fillDataAnalysis" style="width: 0%"></div>
                </div>
                <span class="score-value" id="scoreDataAnalysis">0/10</span>
              </div>
              <div class="review-score">
                <span class="score-label">Conclusion Validity:</span>
                <div class="score-bar">
                  <div class="score-fill" id="fillConclusionValidity" style="width: 0%"></div>
                </div>
                <span class="score-value" id="scoreConclusionValidity">0/10</span>
              </div>
            </div>
            
            <div class="review-comment">
              <h6>Strengths</h6>
              <p id="reviewStrengthsP">AI-generated strengths will appear here.</p>
            </div>
            
            <div class="review-comment">
              <h6>Areas for Improvement</h6>
              <p id="reviewImprovementP">AI-generated areas for improvement will appear here.</p>
            </div>
            
            <div class="review-comment">
              <h6>Specific Recommendations</h6>
              <ol id="reviewRecommendationsList">
                <li>AI-generated recommendations will appear here.</li>
              </ol>
            </div>
            
            <form id="responseForm">
              <div class="mb-3">
                <label for="reviewResponse" class="form-label">Your Response to Reviewer</label>
                <textarea class="form-control" id="reviewResponse" rows="4" placeholder="Respond to the reviewer's comments and suggestions"></textarea>
              </div>
              <div class="mb-3">
                <label for="plannedRevisions" class="form-label">Planned Revisions</label>
                <textarea class="form-control" id="plannedRevisions" rows="3" placeholder="Describe the revisions you plan to make based on the feedback"></textarea>
              </div>
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-primary" id="prevStepBtn">Previous Step</button>
                <button type="button" class="btn btn-primary" id="nextStepBtn">Next: Publication Exporter</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">AI Suggestions</h5>
          </div>
          <div class="card-body">
            <div class="ai-suggestion">
              <div class="ai-suggestion-header">
                <div class="ai-icon">AI</div>
                <h6 class="mb-0">Response Strategy</h6>
              </div>
              <p>When responding to peer review, thank the reviewer for their feedback, address each point specifically, and explain how you plan to incorporate their suggestions.</p>
            </div>
            <div class="ai-suggestion">
              <div class="ai-suggestion-header">
                <div class="ai-icon">AI</div>
                <h6 class="mb-0">Suggested Response</h6>
              </div>
              <p>Thank you for your thoughtful review. We appreciate your recognition of our experimental design and analysis. We agree that expanding the temperature range would strengthen our findings and will address this in our revisions.</p>
            </div>
            <div class="ai-suggestion">
              <div class="ai-suggestion-header">
                <div class="ai-icon">AI</div>
                <h6 class="mb-0">Revision Priorities</h6>
              </div>
              <ul>
                <li>Add error bars to data visualizations</li>
                <li>Expand literature comparison section</li>
                <li>Enhance discussion of applications</li>
                <li>Include additional statistical validation</li>
              </ul>
            </div>
            <button type="button" class="btn btn-outline-primary w-100 mt-3" id="generateAiReviewBtn">Generate AI Peer Review & Draft Response</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="../Hyperion/ai-service.js"></script> --> <!-- Switched to backend API -->
  <script>
    // Check if user is authenticated
    document.addEventListener('DOMContentLoaded', function() {
      const isAuthenticated = localStorage.getItem('isAuthenticated');
      const userEmail = localStorage.getItem('userEmail');
      
      if (!isAuthenticated || !userEmail) {
        // Redirect to login if not authenticated
        window.location.href = '../login.html';
        return;
      }
      
      // Display user email
      document.getElementById('userEmail').textContent = userEmail;
      
      // Handle logout
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('isAuthenticated');
        localStorage.removeItem('userEmail');
        window.location.href = '../login.html';
      });
      
      const scoreScientificMeritEl = document.getElementById('scoreScientificMerit');
      const fillScientificMeritEl = document.getElementById('fillScientificMerit');
      const scoreMethodologyEl = document.getElementById('scoreMethodology');
      const fillMethodologyEl = document.getElementById('fillMethodology');
      const scoreDataAnalysisEl = document.getElementById('scoreDataAnalysis');
      const fillDataAnalysisEl = document.getElementById('fillDataAnalysis');
      const scoreConclusionValidityEl = document.getElementById('scoreConclusionValidity');
      const fillConclusionValidityEl = document.getElementById('fillConclusionValidity');

      const reviewStrengthsPEl = document.getElementById('reviewStrengthsP');
      const reviewImprovementPEl = document.getElementById('reviewImprovementP');
      const reviewRecommendationsListEl = document.getElementById('reviewRecommendationsList');

      const reviewResponseTextarea = document.getElementById('reviewResponse');
      const plannedRevisionsTextarea = document.getElementById('plannedRevisions');
      const scoreElements = {
          ScientificMerit: { text: document.getElementById('scoreScientificMerit'), bar: document.getElementById('fillScientificMerit') },
          Methodology: { text: document.getElementById('scoreMethodology'), bar: document.getElementById('fillMethodology') },
          DataAnalysis: { text: document.getElementById('scoreDataAnalysis'), bar: document.getElementById('fillDataAnalysis') },
          ConclusionValidity: { text: document.getElementById('scoreConclusionValidity'), bar: document.getElementById('fillConclusionValidity') }
      };
      const reviewStrengthsP = document.getElementById('reviewStrengthsP');
      const reviewImprovementP = document.getElementById('reviewImprovementP');
      const reviewRecommendationsList = document.getElementById('reviewRecommendationsList');
      const reviewResponseTextarea = document.getElementById('reviewResponse');
      const plannedRevisionsTextarea = document.getElementById('plannedRevisions');
      const generateAiReviewBtn = document.getElementById('generateAiReviewBtn');
      const nextStepBtn = document.getElementById('nextStepBtn');

      function initializeReviewFields() {
          for (const key in scoreElements) {
              if (scoreElements[key].text) scoreElements[key].text.textContent = "0/10";
              if (scoreElements[key].bar) scoreElements[key].bar.style.width = "0%";
          }
          if (reviewStrengthsP) reviewStrengthsP.textContent = "AI Review Strengths pending...";
          if (reviewImprovementP) reviewImprovementP.textContent = "AI Review Areas for Improvement pending...";
          if (reviewRecommendationsList) reviewRecommendationsList.innerHTML = "<li>AI Review Recommendations pending...</li>";
          if (reviewResponseTextarea) reviewResponseTextarea.value = "";
          if (plannedRevisionsTextarea) plannedRevisionsTextarea.value = "";
      }
      initializeReviewFields(); // Call on load

      generateAiReviewBtn.addEventListener('click', async function() {
        const experimentTitle = localStorage.getItem('experimentTitle') || "N/A";
        const hypothesisStatement = localStorage.getItem('hypothesisStatement') || "N/A";
        const procedure = localStorage.getItem('procedure') || "N/A"; // Assuming this is a summary
        const aiDataInterpretation = localStorage.getItem('aiDataInterpretation') || "N/A";
        const conclusionSummary = localStorage.getItem('conclusionSummary') || "N/A";
        const limitations = localStorage.getItem('limitations') || "N/A";
        const conclusionStatus = localStorage.getItem('conclusionStatus') || "N/A";


        const fullProjectContext = `
          Project Title: ${experimentTitle}
          Hypothesis: "${hypothesisStatement}" (Status: ${conclusionStatus})
          Methodology Summary: ${procedure.substring(0, 150)}...
          AI Data Interpretation: "${aiDataInterpretation}"
          Conclusion Summary: "${conclusionSummary}"
          Identified Limitations: "${limitations}"
          This represents a summary of a research project.
        `;

        generateAiReviewBtn.disabled = true;
        generateAiReviewBtn.textContent = 'Generating AI Review & Response...';
        initializeReviewFields();

        try {
          async function fetchAiData(promptContent) {
              const response = await fetch('http://localhost:5000/api/generate', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ prompt: promptContent }),
              });
              if (!response.ok) {
                  const errorData = await response.json().catch(() => ({ error: 'Failed to parse error from API' }));
                  throw new Error(`API Error (${response.status}): ${errorData.error || response.statusText}`);
              }
              const data = await response.json();
              if (data.error) {
                  throw new Error(`AI Error: ${data.error}`);
              }
              return data.text || '';
          }

          let aiPeerReviewData = { scores: {} };

          for (const aspect in scoreElements) {
            const scorePrompt = `Critically assess the '${aspect}' of a research study summarized as follows: ${fullProjectContext}. Respond with only a numerical score out of 10 (e.g., '8.5').`;
            const scoreText = (await fetchAiData(scorePrompt)).trim();
            const score = parseFloat(scoreText);
            if (!isNaN(score) && scoreElements[aspect].text && scoreElements[aspect].bar) {
              scoreElements[aspect].text.textContent = `${score.toFixed(1)}/10`;
              scoreElements[aspect].bar.style.width = `${score * 10}%`;
              aiPeerReviewData.scores[aspect] = score.toFixed(1);
            } else {
              console.warn(\`AI returned invalid score for \${aspect}: \${scoreText}\`);
              if(scoreElements[aspect].text) scoreElements[aspect].text.textContent = "N/A";
              if(scoreElements[aspect].bar) scoreElements[aspect].bar.style.width = "0%";
              aiPeerReviewData.scores[aspect] = "N/A";
            }
          }

          const strengthsPrompt = `Based on the research summary:\n${fullProjectContext}\nIdentify 2-3 key strengths of this research. Present as a concise paragraph.`;
          aiPeerReviewData.strengths = await fetchAiData(strengthsPrompt);
          if (reviewStrengthsP) reviewStrengthsP.textContent = aiPeerReviewData.strengths || "AI could not generate strengths.";

          const improvementPrompt = `Based on the research summary:\n${fullProjectContext}\nIdentify 2-3 key areas for improvement. Present as a concise paragraph.`;
          aiPeerReviewData.areasForImprovement = await fetchAiData(improvementPrompt);
          if (reviewImprovementP) reviewImprovementP.textContent = aiPeerReviewData.areasForImprovement || "AI could not generate areas for improvement.";

          const recommendationsPrompt = `Based on the research summary:\n${fullProjectContext}\nList 3-4 specific, actionable recommendations for improving this research. Start each with '*' for a bullet point.`;
          const recommendationsRaw = await fetchAiData(recommendationsPrompt);
          aiPeerReviewData.recommendations = recommendationsRaw.split('*').map(rec => rec.trim()).filter(rec => rec);
          if (reviewRecommendationsList) {
            reviewRecommendationsList.innerHTML = '';
            if (aiPeerReviewData.recommendations.length > 0) {
              aiPeerReviewData.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                reviewRecommendationsList.appendChild(li);
              });
            } else {
              reviewRecommendationsList.innerHTML = "<li>AI could not generate recommendations.</li>";
            }
          }
          localStorage.setItem('aiPeerReviewData', JSON.stringify(aiPeerReviewData));

          const generatedReviewSummary = `
              Overall Scores: ${JSON.stringify(aiPeerReviewData.scores)}
              Strengths Noted: ${aiPeerReviewData.strengths}
              Areas for Improvement: ${aiPeerReviewData.areasForImprovement}
              Specific Recommendations: ${aiPeerReviewData.recommendations.join('; ')}
          `;

          const responseDraftPrompt = `Given this AI-generated peer review of a research project:\n${generatedReviewSummary}\nDraft a polite and constructive response from the researcher to this review, acknowledging the points made.`;
          if(reviewResponseTextarea) reviewResponseTextarea.value = await fetchAiData(responseDraftPrompt);

          const revisionsDraftPrompt = `Based on this AI-generated peer review:\n${generatedReviewSummary}\nList specific revisions the researcher plans to make to the project.`;
          if(plannedRevisionsTextarea) plannedRevisionsTextarea.value = await fetchAiData(revisionsDraftPrompt);

          alert('AI-generated peer review and draft response have been populated from the live API!');

        } catch (error) {
          console.error("Error during AI peer review generation:", error);
          alert(`There was an error during AI peer review generation: ${error.message}`);
          // Optionally reset fields further or display error in specific fields
          if (reviewStrengthsP) reviewStrengthsP.textContent = "Error generating review.";
          if (reviewImprovementP) reviewImprovementP.textContent = "Error generating review.";
          if (reviewRecommendationsList) reviewRecommendationsList.innerHTML = "<li>Error.</li>";

        } finally {
          generateAiReviewBtn.disabled = false;
          generateAiReviewBtn.textContent = 'Generate AI Peer Review & Draft Response';
        }
      });
      
      document.getElementById('prevStepBtn').addEventListener('click', function() {
        window.location.href = 'conclusion-drawer.html';
      });
      
      nextStepBtn.addEventListener('click', function() {
        if(reviewResponseTextarea) localStorage.setItem('researcherResponseToReview', reviewResponseTextarea.value);
        if(plannedRevisionsTextarea) localStorage.setItem('plannedRevisionsBasedOnReview', plannedRevisionsTextarea.value);
        // aiPeerReviewData is already saved within the generateAiReviewBtn listener
        localStorage.setItem('currentStep', 'Published');
        window.location.href = 'publication-exporter.html';
      });
    });
  </script>
</body>
</html>
